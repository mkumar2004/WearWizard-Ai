const express = require('express');
const openai = require('../Config/openRouter');
const router = express.Router();

// ============================================
// IMAGE FETCHING FROM MULTIPLE SOURCES
// ============================================

// Configuration - Add your API keys in .env file
const API_KEYS = {
  GOOGLE_API_KEY: process.env.GOOGLE_API_KEY || '', // https://console.cloud.google.com/
  GOOGLE_CX: process.env.GOOGLE_CX || '', // https://programmablesearchengine.google.com/
  PEXELS_API_KEY: process.env.PEXELS_API_KEY || '', // https://www.pexels.com/api/
  UNSPLASH_ACCESS_KEY: process.env.UNSPLASH_ACCESS_KEY || '', // https://unsplash.com/developers
  PIXABAY_API_KEY: process.env.PIXABAY_API_KEY || '', // https://pixabay.com/api/docs/
  BING_API_KEY: process.env.BING_API_KEY || '' // https://www.microsoft.com/en-us/bing/apis/bing-image-search-api
};

// ============================================
// 1. GOOGLE CUSTOM SEARCH (Best Quality)
// ============================================
async function fetchGoogleImage(keyword) {
  if (!API_KEYS.GOOGLE_API_KEY || !API_KEYS.GOOGLE_CX) {
    return null;
  }

  try {
    const url = `https://www.googleapis.com/customsearch/v1?q=${encodeURIComponent(keyword)}&searchType=image&key=${API_KEYS.GOOGLE_API_KEY}&cx=${API_KEYS.GOOGLE_CX}&num=1`;
    
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.items && data.items[0]) {
      return data.items[0].link;
    }
  } catch (error) {
    console.error('Google Image Search error:', error.message);
  }
  
  return null;
}

// ============================================
// 2. PEXELS API (200 requests/hour)
// ============================================
async function fetchPexelsImage(keyword) {
  if (!API_KEYS.PEXELS_API_KEY) {
    return null;
  }

  try {
    const response = await fetch(
      `https://api.pexels.com/v1/search?query=${encodeURIComponent(keyword)}&per_page=1`,
      {
        headers: { 'Authorization': API_KEYS.PEXELS_API_KEY }
      }
    );
    
    const data = await response.json();
    
    if (data.photos && data.photos[0]) {
      return data.photos[0].src.large2x || data.photos[0].src.large;
    }
  } catch (error) {
    console.error('Pexels API error:', error.message);
  }
  
  return null;
}

// ============================================
// 3. UNSPLASH API (50 requests/hour)
// ============================================
async function fetchUnsplashImage(keyword) {
  if (!API_KEYS.UNSPLASH_ACCESS_KEY) {
    return null;
  }

  try {
    const response = await fetch(
      `https://api.unsplash.com/search/photos?query=${encodeURIComponent(keyword)}&per_page=1`,
      {
        headers: { 'Authorization': `Client-ID ${API_KEYS.UNSPLASH_ACCESS_KEY}` }
      }
    );
    
    const data = await response.json();
    
    if (data.results && data.results[0]) {
      return data.results[0].urls.regular;
    }
  } catch (error) {
    console.error('Unsplash API error:', error.message);
  }
  
  return null;
}

// ============================================
// 4. PIXABAY API (100 requests/minute)
// ============================================
async function fetchPixabayImage(keyword) {
  if (!API_KEYS.PIXABAY_API_KEY) {
    return null;
  }

  try {
    const response = await fetch(
      `https://pixabay.com/api/?key=${API_KEYS.PIXABAY_API_KEY}&q=${encodeURIComponent(keyword)}&image_type=photo&per_page=3`
    );
    
    const data = await response.json();
    
    if (data.hits && data.hits[0]) {
      return data.hits[0].largeImageURL || data.hits[0].webformatURL;
    }
  } catch (error) {
    console.error('Pixabay API error:', error.message);
  }
  
  return null;
}

// ============================================
// 5. WIKIMEDIA COMMONS (Unlimited, Free)
// ============================================
async function fetchWikimediaImage(keyword) {
  try {
    const searchUrl = `https://commons.wikimedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(keyword)}&srnamespace=6&format=json&origin=*`;
    
    const response = await fetch(searchUrl);
    const data = await response.json();
    
    if (data.query?.search?.[0]) {
      const fileName = data.query.search[0].title;
      
      const imageUrl = `https://commons.wikimedia.org/w/api.php?action=query&titles=${encodeURIComponent(fileName)}&prop=imageinfo&iiprop=url&format=json&origin=*`;
      
      const imageResponse = await fetch(imageUrl);
      const imageData = await imageResponse.json();
      
      const pages = imageData.query.pages;
      const page = pages[Object.keys(pages)[0]];
      
      if (page.imageinfo?.[0]?.url) {
        return page.imageinfo[0].url;
      }
    }
  } catch (error) {
    console.error('Wikimedia API error:', error.message);
  }
  
  return null;
}

// ============================================
// 6. BING IMAGE SEARCH (1000/month)
// ============================================
async function fetchBingImage(keyword) {
  if (!API_KEYS.BING_API_KEY) {
    return null;
  }

  try {
    const response = await fetch(
      `https://api.bing.microsoft.com/v7.0/images/search?q=${encodeURIComponent(keyword)}&count=1`,
      {
        headers: { 'Ocp-Apim-Subscription-Key': API_KEYS.BING_API_KEY }
      }
    );
    
    const data = await response.json();
    
    if (data.value && data.value[0]) {
      return data.value[0].contentUrl;
    }
  } catch (error) {
    console.error('Bing Image Search error:', error.message);
  }
  
  return null;
}

// ============================================
// FALLBACK: Unsplash Source (Always works)
// ============================================
function getUnsplashSourceImage(keyword) {
  return `https://source.unsplash.com/800x600/?${encodeURIComponent(keyword)}`;
}

// ============================================
// MAIN AGGREGATOR - Tries all sources
// ============================================
async function fetchImageFromMultipleSources(keyword) {
  console.log(`Fetching image for: ${keyword}`);
  
  // Priority 1: Google Custom Search (Best quality)
  let imageUrl = await fetchGoogleImage(keyword);
  if (imageUrl) {
    console.log(`✓ Found via Google: ${keyword}`);
    return imageUrl;
  }
  
  // Priority 2: Pexels (High quality, 200/hour)
  imageUrl = await fetchPexelsImage(keyword);
  if (imageUrl) {
    console.log(`✓ Found via Pexels: ${keyword}`);
    return imageUrl;
  }
  
  // Priority 3: Unsplash (High quality, 50/hour)
  imageUrl = await fetchUnsplashImage(keyword);
  if (imageUrl) {
    console.log(`✓ Found via Unsplash: ${keyword}`);
    return imageUrl;
  }
  
  // Priority 4: Wikimedia Commons (Unlimited, good for landmarks)
  imageUrl = await fetchWikimediaImage(keyword);
  if (imageUrl) {
    console.log(`✓ Found via Wikimedia: ${keyword}`);
    return imageUrl;
  }
  
  // Priority 5: Pixabay (100/min)
  imageUrl = await fetchPixabayImage(keyword);
  if (imageUrl) {
    console.log(`✓ Found via Pixabay: ${keyword}`);
    return imageUrl;
  }
  
  // Priority 6: Bing (1000/month)
  imageUrl = await fetchBingImage(keyword);
  if (imageUrl) {
    console.log(`✓ Found via Bing: ${keyword}`);
    return imageUrl;
  }
  
  // Final Fallback: Unsplash Source (Always works)
  console.log(`→ Using Unsplash Source fallback: ${keyword}`);
  return getUnsplashSourceImage(keyword);
}

// ============================================
// AI PROMPT
// ============================================
const TRAVEL_PLANNER_PROMPT = `
You are an AI Travel Planner.

CRITICAL RULES:
- Return ONLY valid JSON
- Do NOT include explanations, comments, or markdown
- Do NOT truncate the response
- All arrays and objects must be fully completed

FOR IMAGES: Provide search keywords/terms only (NOT URLs)
- Keywords should be specific and descriptive
- Example: "Meenakshi Temple Madurai", "South Indian food thali", "Madurai street market"

JSON FORMAT:

{
  "travelPlan": {
    "destination": "destination name",
    "imageKeyword": "specific search term for destination",
    "duration": "X days",
    "travelStyle": "style description",
    "bestTimeToVisit": "best time",
    "overview": "destination overview",
    "costperday": 50,
    "dayWiseItinerary": [
      {
        "day": 1,
        "title": "Day title",
        "imageKeyword": "specific search term for this day",
        "activities": [
          {
            "time": "HH:MM AM/PM",
            "activity": "Activity description"
          }
        ]
      }
    ],
    "topAttractions": [
      {
        "name": "Attraction name",
        "imageKeyword": "specific search term for attraction"
      }
    ],
    "localFoodsToTry": ["food1", "food2"],
    "transportTips": ["tip1", "tip2"],
    "staySuggestions": "stay suggestions text",
    "estimatedBudget": "budget estimate",
    "travelTips": ["tip1", "tip2"]
  }
}
`;

// ============================================
// PROCESS TRAVEL PLAN - Convert keywords to images
// ============================================
async function addImagestoTravelPlan(travelPlan) {
  // Main destination image
  if (travelPlan.imageKeyword) {
    travelPlan.image = await fetchImageFromMultipleSources(travelPlan.imageKeyword);
    delete travelPlan.imageKeyword;
  }

  // Day-wise itinerary images
  if (travelPlan.dayWiseItinerary) {
    for (let dayPlan of travelPlan.dayWiseItinerary) {
      if (dayPlan.imageKeyword) {
        dayPlan.image = await fetchImageFromMultipleSources(dayPlan.imageKeyword);
        delete dayPlan.imageKeyword;
      }
    }
  }

  // Top attractions images
  if (travelPlan.topAttractions) {
    for (let attraction of travelPlan.topAttractions) {
      if (attraction.imageKeyword) {
        attraction.image = await fetchImageFromMultipleSources(attraction.imageKeyword);
        delete attraction.imageKeyword;
      }
    }
  }

  return travelPlan;
}

// ============================================
// MAIN ROUTE
// ============================================
router.post('/chat', async (req, res) => {
  try {
    const { msg } = req.body;

    if (!msg) {
      return res.status(400).json({
        success: false,
        error: "Message is required"
      });
    }

    // Step 1: Get travel plan from AI
    const completion = await openai.chat.completions.create({
      model: "meta-llama/llama-3.1-8b-instruct",
      messages: [
        { role: "system", content: TRAVEL_PLANNER_PROMPT },
        { role: "user", content: msg }
      ],
      temperature: 0.4,
      max_tokens: 1500
    });

    const rawText = completion.choices[0].message.content.trim();

    // Step 2: Parse JSON
    let parsed;
    try {
      parsed = JSON.parse(rawText);
    } catch (err) {
      return res.status(500).json({
        success: false,
        error: "AI response is not valid JSON",
        raw: rawText
      });
    }

    // Step 3: Fetch real images from multiple sources
    if (parsed.travelPlan) {
      parsed.travelPlan = await addImagestoTravelPlan(parsed.travelPlan);
    }

    // Step 4: Return complete travel plan with images
    res.json({
      success: true,
      reply: parsed
    });

  } catch (error) {
    console.error(error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

module.exports = router;